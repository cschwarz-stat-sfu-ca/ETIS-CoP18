#  Sets up covariates for countries x years for main analysis.
#
#  Gets data from subsidiary vars in database, 
#  and applies patches for incomplete series.
#
#  This file needs to be modified for each analysis 
#  depending on which variables are required or are available
#______________________________________________________________________________________
#  INPUTS
#     R package: RPostgreSQL
#     R package: tidyverse
#     R file: PG settings.R
#     R file: get subsid vars.R  Functions to extract data and var names from database
#     csv file: CTS_ALL_ddmmYYYY.csv  Countries to be included in the analysis 
#______________________________________________________________________________________
#  OUTPUTS
#      covars_ddmmYYYY.csv where ddmmYYYY is the current date
#      File contains relevant covariates summarised for each country in each year 
#======================================================================================
#
#  Set range of years of seizure to include;
#   leave as 1900 - 2100 to include ALL years in database:
#
#year.from <- 2007  ## CJS set outside code
# year.to <- 2017   ## CJS set outside code
#______________________________________________________________________
# File name for list of countries to be included in the analysis
#ctry.name <- 'CTS_ALL_17072018.csv'
ctry.name <- 'CTS_ALL_16012021.csv'  ## CJS updated file name
#______________________________________________________________________
#
#  Set path name, in quotes, for working folder
#
#path.code <- 'C:/ETIS/analysis/R Code'         ## CJS set outside code
#path.data <- 'C:/ETIS/analysis/Processed Data' ## CJS set outside code
# 

setwd(path.Rcode)  # changed to Rcode
source('PG settings.R')
setwd(path.data)
#______________________________________________________________________


load.pkgs <- function() {
  library(RPostgreSQL)
  library(tidyverse)
}
suppressPackageStartupMessages(load.pkgs())
#
drv <- dbDriver('PostgreSQL')
con <- dbConnect(drv, host = host.name, port = pg.port, user = user.name,
                 password = passwd, dbname = db.name)

# Identify the countries
cts.df <- read.csv(ctry.name)
cts <- sort(cts.df$ctry)
num.cts <- length(cts)

setwd(path.Rcode)   # changed to path.Rcode
source('get subsid vars.R')

# To inspect the currently available subsid vars in the DB, execute get.subsid.names()
get.subsid.names()
# id                          name                             source
# 1   1  corruption_perceptions_index         Transparency International
# 2   2          voice&accountability                     World Bank WGI
# 3   3           political_stability                     World Bank WGI
# 4   4      government_effectiveness                     World Bank WGI
# 5   5            regulatory_quality                     World Bank WGI
# 6   6                   rule_of_law                     World Bank WGI
# 7   7         control_of_corruption                     World Bank WGI
# 8   8               DC_mode_passive                               TESA
# 9   9              DC_mode_prompted                               TESA
# 10 10              DC_mode_targeted                               TESA
# 11 11             legislation_score                  CITES Secretariat
# 12 12 CITES_reporting_score_reports                  CITES Secretariat
# 13 13   CITES_reporting_score_years                  CITES Secretariat
# 14 14       human_development_index             UN Statistics Division
# 15 15                per_capita_gdp IMF/WEO (& UN Statistics Division)
# 16 16              gini_coefficient      World Bank poverty indicators
# 17 17                      LE_ratio                               TESA
# 18 18               LE_ratio_lagged                               TESA

# The id's of the required subsid vars (1:18 below) are obtained from the list of names.
# Decide not to use gini_coeficient as there is so little data

var.id <- c(1:15, 17, 18)

# this is slow so WAIT ...
df.all <- get.subsid.data(var.id = var.id, countries = cts, year.from = year.from, year.to = year.to)
df.all <- df.all[order(df.all$year, df.all$ctry),]

# List variables with missing data
num.miss <- array(data = NA, dim = c(length(unique(df.all$ctry)), length(unique(df.all$year)),
                                length(var.id)))
for (i in 1:length(var.id))
  num.miss[,,i] <- (with(df.all, tapply(is.na(df.all[ ,(i+2)]), list(ctry, year), sum)))

var.yr.miss <- apply(num.miss, c(2, 3), sum)
colnames(var.yr.miss) <- names(df.all)[-(1:2)]
rownames(var.yr.miss) <- year.from:year.to
t(var.yr.miss)

# Note variables 2:7 have no  data for 2017 - so omit
# Variable 14 has no data for 2016 or 2017 - so omit
# Three countries have missing data on the data collection score

ctry.id <- levels(df.all$ctry)
ctry.id[num.miss[ , 1, c(13,14)]>0]

# compute DC mode proportions prompted & targeted
df.all$all.sz <- df.all$DC_mode_passive + df.all$DC_mode_prompted + df.all$DC_mode_targeted
df.all$pr.prompted <- df.all$DC_mode_prompted/df.all$all.sz
df.all$pr.targeted <- df.all$DC_mode_targeted/df.all$all.sz

# assumed DC scores where missing
df.all$pr.prompted[is.na(df.all$pr.prompted)] <-0
df.all$pr.targeted[is.na(df.all$pr.targeted)] <-0

# assign LE ratio = 0 for 0/0 cases
df.all$LE_ratio[is.na(df.all$LE_ratio)] <- 0
df.all$LE_ratio_lagged[is.na(df.all$LE_ratio_lagged)] <- 0

# CITES reporting rate
df.all$rep.sc <- df.all$CITES_reporting_score_reports/df.all$CITES_reporting_score_years
df.all$rep.sc[is.na(df.all$rep.sc)] <- 0

# CITES reporting rate:  emp. logit
emp.logit <- function(y,n) log((y + 0.5)/(n - y + 0.5))
rep.log <-
  emp.logit(df.all$CITES_reporting_score_reports, df.all$CITES_reporting_score_years)
rep.log[is.na(rep.log)] <- emp.logit(0,1)

# prepare data frame for use in analysis
df.covars <- data.frame(ctry    = df.all$ctry,
                        year    = df.all$year,
                        cpi     = df.all$corruption_perceptions_index,
                        gdp     = df.all$per_capita_gdp,
                        legis   = df.all$legislation_score,
                        dc.pr   = df.all$pr.prompted,
                        dc.ta   = df.all$pr.targeted,
                        LE      = df.all$LE_ratio,
                        LE1     = df.all$LE_ratio_lagged,
                        rep.sc  = df.all$rep.sc,
                        rep.log = rep.log)

# Write to file
setwd(path.data)

filename <- paste('covars_',format(Sys.Date(),'%d%m%Y'),'.csv', sep='')
write.csv(df.covars, file = filename, row.names = F)

# --------------------------------------------------------------------------------- #
# Â© 2019 University of Reading/TRAFFIC International/RW Burn & FM Underwood         #
# Please see the License.md file at                                                 #
# https://github.com/fmunderwood/ETIS_CITESReporting_RCode/blob/v.CoP18/License.md  #
# for more information about the copyright and license details of this file.        #
# --------------------------------------------------------------------------------- #
